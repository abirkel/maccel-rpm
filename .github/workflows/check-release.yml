---
name: Check Maccel Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load container config
        id: config
        run: |
          source .github/workflows/config.env
          echo "container_image=$CONTAINER_IMAGE" >> $GITHUB_ENV
          echo "container_version=$CONTAINER_VERSION" >> $GITHUB_ENV
          echo "enable_kmod=$ENABLE_KMOD" >> $GITHUB_OUTPUT

      - name: Get latest maccel release
        id: get_release
        run: |
          LATEST_TAG=$(gh api \
            repos/Gnarus-G/maccel/releases/latest --jq '.tag_name')
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "Latest maccel release: $LATEST_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if release is new
        id: check_new
        run: |
          LATEST_TAG="${{ steps.get_release.outputs.latest_tag }}"

          if [ -f .external_release_tag ]; then
            CURRENT_TAG=$(cat .external_release_tag)
            echo "Current tracked tag: $CURRENT_TAG"
          else
            CURRENT_TAG=""
            echo "No existing tag file found"
          fi

          if [ "$LATEST_TAG" != "$CURRENT_TAG" ]; then
            echo "is_new=true" >> "$GITHUB_OUTPUT"
            echo "New release detected: $LATEST_TAG"
          else
            echo "is_new=false" >> "$GITHUB_OUTPUT"
            echo "No new release (current: $CURRENT_TAG)"
          fi

      - name: Update release tag file
        if: steps.check_new.outputs.is_new == 'true'
        run: |
          LATEST="${{ steps.get_release.outputs.latest_tag }}"
          echo "$LATEST" > .external_release_tag

      - name: Commit and push changes
        if: steps.check_new.outputs.is_new == 'true'
        run: |
          git add .external_release_tag
          LATEST="${{ steps.get_release.outputs.latest_tag }}"
          git commit -m "chore: update maccel release to $LATEST" && \
            git push

      - name: Pull and inspect container image
        if: steps.config.outputs.enable_kmod == 'true'
        id: inspect_image
        run: |
          IMAGE_FULL="${{ env.container_image }}"
          CONTAINER_VERSION="${{ env.container_version }}"
          
          # Pull image
          docker pull "${IMAGE_FULL}:${CONTAINER_VERSION}"
          
          # Extract digest and build full identifier
          IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE_FULL}:${CONTAINER_VERSION}")
          IMAGE_IDENTIFIER="${IMAGE_FULL}:${CONTAINER_VERSION}@${IMAGE_DIGEST#*@}"
          
          echo "image_identifier=$IMAGE_IDENTIFIER" >> "$GITHUB_OUTPUT"
          echo "Image identifier: $IMAGE_IDENTIFIER"

      - name: Check if image changed
        if: steps.config.outputs.enable_kmod == 'true'
        id: check_image_new
        run: |
          IMAGE_IDENTIFIER="${{ steps.inspect_image.outputs.image_identifier }}"
          
          if [ -f .external_image_tag ]; then
            CURRENT_IMAGE_IDENTIFIER=$(cat .external_image_tag)
            echo "Current tracked image: $CURRENT_IMAGE_IDENTIFIER"
          else
            CURRENT_IMAGE_IDENTIFIER=""
            echo "No existing image tag file found"
          fi
          
          if [ "$IMAGE_IDENTIFIER" != "$CURRENT_IMAGE_IDENTIFIER" ]; then
            echo "is_new=true" >> "$GITHUB_OUTPUT"
            echo "New image detected: $IMAGE_IDENTIFIER"
          else
            echo "is_new=false" >> "$GITHUB_OUTPUT"
            echo "No image change (current: $CURRENT_IMAGE_IDENTIFIER)"
          fi

      - name: Extract kernel version from image
        if: steps.config.outputs.enable_kmod == 'true' && steps.check_image_new.outputs.is_new == 'true'
        id: extract_kernel
        run: |
          IMAGE_FULL="${{ env.container_image }}"
          CONTAINER_VERSION="${{ env.container_version }}"
          
          # Extract kernel version from already-pulled image
          KERNEL_VERSION=$(docker run --rm "${IMAGE_FULL}:${CONTAINER_VERSION}" rpm -q kernel-devel --queryformat '%{VERSION}-%{RELEASE}\n' | head -1)
          
          echo "kernel_version=$KERNEL_VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted kernel version: $KERNEL_VERSION"

      - name: Check if kernel version changed
        if: steps.config.outputs.enable_kmod == 'true' && steps.check_image_new.outputs.is_new == 'true'
        id: check_kernel_new
        run: |
          LATEST_KERNEL_VERSION="${{ steps.extract_kernel.outputs.kernel_version }}"
          
          if [ -f .external_kernel_version ]; then
            CURRENT_KERNEL_VERSION=$(cat .external_kernel_version)
            echo "Current tracked kernel version: $CURRENT_KERNEL_VERSION"
          else
            CURRENT_KERNEL_VERSION=""
            echo "No existing kernel version file found"
          fi
          
          if [ "$LATEST_KERNEL_VERSION" != "$CURRENT_KERNEL_VERSION" ]; then
            echo "is_new=true" >> "$GITHUB_OUTPUT"
            echo "New kernel version detected: $LATEST_KERNEL_VERSION"
          else
            echo "is_new=false" >> "$GITHUB_OUTPUT"
            echo "No kernel version change (current: $CURRENT_KERNEL_VERSION)"
          fi

      - name: Update image and kernel version files
        if: steps.config.outputs.enable_kmod == 'true' && steps.check_kernel_new.outputs.is_new == 'true'
        run: |
          IMAGE_IDENTIFIER="${{ steps.inspect_image.outputs.image_identifier }}"
          LATEST_KERNEL_VERSION="${{ steps.extract_kernel.outputs.kernel_version }}"
          echo "$IMAGE_IDENTIFIER" > .external_image_tag
          echo "$LATEST_KERNEL_VERSION" > .external_kernel_version

      - name: Commit and push image updates
        if: steps.config.outputs.enable_kmod == 'true' && steps.check_kernel_new.outputs.is_new == 'true'
        run: |
          git add .external_image_tag .external_kernel_version
          IMAGE_IDENTIFIER="${{ steps.inspect_image.outputs.image_identifier }}"
          LATEST_KERNEL_VERSION="${{ steps.extract_kernel.outputs.kernel_version }}"
          git commit -m "chore: update container image (kernel $LATEST_KERNEL_VERSION)" && \
            git push

      - name: Trigger RPM build workflow (maccel update)
        if: steps.check_new.outputs.is_new == 'true'
        run: |
          gh workflow run build-rpm.yml -f update_specs=true -f build_akmod=true -f build_cli=true -f build_kmod=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger RPM build workflow (image update - kmod only)
        if: steps.config.outputs.enable_kmod == 'true' && steps.check_kernel_new.outputs.is_new == 'true'
        run: |
          gh workflow run build-rpm.yml -f update_specs=true -f build_akmod=false -f build_cli=false -f build_kmod=true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
