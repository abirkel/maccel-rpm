---
name: Check Upstream Versions

'on':
  schedule:
    - cron: '0 6 * * *'  # Build at 06:00 UTC every day (20 minutes after ublue images start building)
  workflow_dispatch:

jobs:
  check_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: Get latest maccel release
        id: get_maccel
        run: |
          LATEST_TAG=$(gh api \
            repos/Gnarus-G/maccel/releases/latest --jq '.tag_name')
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "Latest maccel release: $LATEST_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Aurora kernel version
        id: get_aurora_kernel
        run: |
          chmod +x scripts/resolve-kernel-version.sh
          AURORA_KERNEL=$(
            ./scripts/resolve-kernel-version.sh --kernel-type main
          )
          echo "kernel_version=$AURORA_KERNEL" >> "$GITHUB_OUTPUT"
          echo "Aurora kernel version: $AURORA_KERNEL"

      - name: Get Bazzite kernel version
        id: get_bazzite_kernel
        run: |
          BAZZITE_KERNEL=$(
            ./scripts/resolve-kernel-version.sh --kernel-type bazzite
          )
          echo "kernel_version=$BAZZITE_KERNEL" >> "$GITHUB_OUTPUT"
          echo "Bazzite kernel version: $BAZZITE_KERNEL"

      - name: Load current versions
        id: load_versions
        run: |
          if [ -f .external_versions ]; then
            source .external_versions
            echo "maccel_version=${MACCEL_VERSION:-}" \
              >> "$GITHUB_OUTPUT"
            echo "aurora_kernel_version=${AURORA_KERNEL_VERSION:-}" \
              >> "$GITHUB_OUTPUT"
            echo "bazzite_kernel_version=${BAZZITE_KERNEL_VERSION:-}" \
              >> "$GITHUB_OUTPUT"
          else
            echo "maccel_version=" >> "$GITHUB_OUTPUT"
            echo "aurora_kernel_version=" >> "$GITHUB_OUTPUT"
            echo "bazzite_kernel_version=" >> "$GITHUB_OUTPUT"
          fi

      - name: Compare versions and determine build targets
        id: check_changes
        run: |
          LATEST_MACCEL="${{ steps.get_maccel.outputs.latest_tag }}"
          CURRENT_MACCEL="${{
            steps.load_versions.outputs.maccel_version
          }}"

          LATEST_AURORA="${{
            steps.get_aurora_kernel.outputs.kernel_version
          }}"
          CURRENT_AURORA="${{
            steps.load_versions.outputs.aurora_kernel_version
          }}"

          LATEST_BAZZITE="${{
            steps.get_bazzite_kernel.outputs.kernel_version
          }}"
          CURRENT_BAZZITE="${{
            steps.load_versions.outputs.bazzite_kernel_version
          }}"

          echo "=== Version Comparison ==="
          echo "Maccel:  $CURRENT_MACCEL -> $LATEST_MACCEL"
          echo "Aurora:  $CURRENT_AURORA -> $LATEST_AURORA"
          echo "Bazzite: $CURRENT_BAZZITE -> $LATEST_BAZZITE"

          # Determine what changed
          MACCEL_CHANGED=false
          AURORA_CHANGED=false
          BAZZITE_CHANGED=false

          if [ "$LATEST_MACCEL" != "$CURRENT_MACCEL" ]; then
            MACCEL_CHANGED=true
            echo "✓ Maccel version changed"
          fi

          if [ "$LATEST_AURORA" != "$CURRENT_AURORA" ]; then
            AURORA_CHANGED=true
            echo "✓ Aurora kernel version changed"
          fi

          if [ "$LATEST_BAZZITE" != "$CURRENT_BAZZITE" ]; then
            BAZZITE_CHANGED=true
            echo "✓ Bazzite kernel version changed"
          fi

          # Determine which kernel types need building
          KERNEL_TYPES=""
          BUILD_CLI=false
          NEEDS_BUILD=false

          if [ "$MACCEL_CHANGED" = true ]; then
            # New maccel version: build for both kernel types
            KERNEL_TYPES="main,bazzite"
            BUILD_CLI=true
            NEEDS_BUILD=true
            echo "→ Building for both kernel types (new maccel)"
          else
            # Check individual kernel changes
            if [ "$AURORA_CHANGED" = true ]; then
              KERNEL_TYPES="main"
              NEEDS_BUILD=true
              echo "→ Building for main kernel (Aurora changed)"
            fi

            if [ "$BAZZITE_CHANGED" = true ]; then
              if [ -n "$KERNEL_TYPES" ]; then
                KERNEL_TYPES="$KERNEL_TYPES,bazzite"
              else
                KERNEL_TYPES="bazzite"
              fi
              NEEDS_BUILD=true
              echo "→ Building for bazzite kernel (Bazzite changed)"
            fi
          fi

          # Set outputs
          echo "needs_build=$NEEDS_BUILD" >> "$GITHUB_OUTPUT"
          echo "kernel_types=$KERNEL_TYPES" >> "$GITHUB_OUTPUT"
          echo "build_cli=$BUILD_CLI" >> "$GITHUB_OUTPUT"
          echo "maccel_version=$LATEST_MACCEL" >> "$GITHUB_OUTPUT"
          echo "aurora_kernel=$LATEST_AURORA" >> "$GITHUB_OUTPUT"
          echo "bazzite_kernel=$LATEST_BAZZITE" >> "$GITHUB_OUTPUT"

          echo ""
          if [ "$NEEDS_BUILD" = true ]; then
            echo "=== Build Required ==="
            echo "Kernel types: $KERNEL_TYPES"
            echo "Build CLI: $BUILD_CLI"
            echo "Maccel version: $LATEST_MACCEL"
          else
            echo "→ No changes detected, no build needed"
          fi

      - name: Update versions file
        if: steps.check_changes.outputs.needs_build == 'true'
        run: |
          MACCEL_VERSION="${{
            steps.check_changes.outputs.maccel_version
          }}"
          AURORA_KERNEL_VERSION="${{
            steps.check_changes.outputs.aurora_kernel
          }}"
          BAZZITE_KERNEL_VERSION="${{
            steps.check_changes.outputs.bazzite_kernel
          }}"

          cat > .external_versions << EOF
          MACCEL_VERSION=$MACCEL_VERSION
          AURORA_KERNEL_VERSION=$AURORA_KERNEL_VERSION
          BAZZITE_KERNEL_VERSION=$BAZZITE_KERNEL_VERSION
          EOF

          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"
          git add .external_versions
          COMMIT_MSG="chore: update versions"
          COMMIT_MSG="$COMMIT_MSG - maccel: $MACCEL_VERSION"
          COMMIT_MSG="$COMMIT_MSG, aurora: $AURORA_KERNEL_VERSION"
          COMMIT_MSG="$COMMIT_MSG, bazzite: $BAZZITE_KERNEL_VERSION"
          git commit -m "$COMMIT_MSG" && git push

      - name: Trigger RPM build workflow
        if: steps.check_changes.outputs.needs_build == 'true'
        run: |
          MACCEL_VERSION="${{ steps.check_changes.outputs.maccel_version }}"
          KERNEL_TYPES="${{ steps.check_changes.outputs.kernel_types }}"
          BUILD_CLI="${{ steps.check_changes.outputs.build_cli }}"

          echo "Triggering build with:"
          echo "  maccel_version: $MACCEL_VERSION"
          echo "  kernel_types: $KERNEL_TYPES"
          echo "  build_cli: $BUILD_CLI"

          gh workflow run build-rpm.yml --ref ${{ github.ref_name }} \
            -f maccel_version="$MACCEL_VERSION" \
            -f kernel_types="$KERNEL_TYPES" \
            -f build_cli="$BUILD_CLI"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
