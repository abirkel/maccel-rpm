---
name: Build and Publish RPM Packages

'on':
  push:
    paths:
      - '.external_release_tag'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if version unchanged'
        required: false
        type: boolean
        default: false
      build_akmod:
        description: 'Build akmod package'
        required: false
        type: boolean
        default: true
      build_cli:
        description: 'Build CLI package'
        required: false
        type: boolean
        default: true
      build_kmod:
        description: 'Build kmod package'
        required: false
        type: boolean
        default: false
      container_image:
        description: 'Container image to use (e.g., fedora, ghcr.io/ublue-os/aurora-nvidia-open)'
        required: false
        type: string
        default: 'fedora'
      fedora_version:
        description: 'Fedora version to use (e.g., latest, 40, 41)'
        required: false
        type: string
        default: 'latest'

permissions:
  contents: write
  packages: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: ${{ github.event.inputs.container_image }}:${{ github.event.inputs.fedora_version }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      container_image: ${{ steps.build_info.outputs.container_image }}
      container_digest: ${{ steps.build_info.outputs.container_digest }}
      kernel_version: ${{ steps.build_info.outputs.kernel_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read maccel version
        id: version
        run: |
          VERSION=$(cat .external_release_tag)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Load container config
        id: config
        run: |
          source .github/workflows/config.env
          echo "container_image=$CONTAINER_IMAGE" >> $GITHUB_ENV
          echo "container_version=$CONTAINER_VERSION" >> $GITHUB_ENV

      - name: Capture build info
        id: build_info
        run: |
          # Use inputs if provided, otherwise fall back to config.env
          CONTAINER_IMAGE="${{ github.event.inputs.container_image }}"
          CONTAINER_VERSION="${{ github.event.inputs.fedora_version }}"
          
          if [ -z "$CONTAINER_IMAGE" ]; then
            CONTAINER_IMAGE="${{ env.container_image }}"
          fi
          if [ -z "$CONTAINER_VERSION" ]; then
            CONTAINER_VERSION="${{ env.container_version }}"
          fi
          
          # Capture container digest
          CONTAINER_DIGEST=$(cat /proc/self/cgroup | grep docker | sed 's/^.*\([0-9a-f]\{12\}\)[0-9a-f]*$/\1/' | head -1)
          
          # Capture kernel version
          KERNEL_VERSION=$(uname -r)
          
          echo "container_image=${CONTAINER_IMAGE}:${CONTAINER_VERSION}" >> $GITHUB_OUTPUT
          echo "container_digest=${CONTAINER_DIGEST}" >> $GITHUB_OUTPUT
          echo "kernel_version=${KERNEL_VERSION}" >> $GITHUB_OUTPUT

      - name: Update spec files with new version
        if: github.event_name == 'push'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          VERSION_NUM=${VERSION#v}
          CHANGELOG_DATE=$(date "+%a %b %d %Y")
          MAINTAINER="github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          for spec in specs/*.spec; do
            # Update Version field
            sed -i "s/^Version:.*/Version:        ${VERSION_NUM}/" "$spec"

            # Generate changelog entry
            CHANGELOG_ENTRY="* ${CHANGELOG_DATE} ${MAINTAINER} - ${VERSION_NUM}-1\n- Update to maccel version ${VERSION_NUM}"

            # Insert changelog entry after %changelog line
            sed -i "/^%changelog$/a ${CHANGELOG_ENTRY}" "$spec"
          done

      - name: Install build dependencies
        run: |
          # Step 1: Install base RPM build tools
          dnf install -y rpm-build rpmdevtools rpmlint createrepo_c rpm-sign gnupg2 pinentry spectool
          
          # Step 2: Install BuildRequires from spec files
          dnf builddep -y specs/*.spec

      - name: Setup RPM build tree
        run: rpmdev-setuptree

      - name: Download maccel source
        run: |
          spectool -g -R specs/*.spec

      - name: Copy spec files
        run: |
          cp specs/*.spec ~/rpmbuild/SPECS/

      - name: Build akmod-maccel
        if: github.event.inputs.build_akmod == 'true'
        run: |
          cd ~/rpmbuild/SPECS
          rpmbuild -ba akmod-maccel.spec
        env:
          MACCEL_VERSION: ${{ steps.version.outputs.version }}

      - name: Build maccel CLI
        if: github.event.inputs.build_cli == 'true'
        run: |
          cd ~/rpmbuild/SPECS
          rpmbuild -ba maccel.spec
        env:
          MACCEL_VERSION: ${{ steps.version.outputs.version }}

      - name: Build kmod-maccel
        if: github.event.inputs.build_kmod == 'true'
        run: |
          cd ~/rpmbuild/SPECS
          rpmbuild -ba kmod-maccel.spec
          
          # Get kernel version
          KVER=$(uname -r)
          
          # Rename kmod package to include kernel version
          cd ~/rpmbuild/RPMS/x86_64
          for rpm in kmod-maccel-*.rpm; do
            if [[ "$rpm" != *"+"* ]]; then
              # Extract version and release from filename
              # kmod-maccel-0.5.6-1.fc41.x86_64.rpm -> kmod-maccel-0.5.6-1+6.12.1.fc41.x86_64.rpm
              NEW_NAME=$(echo "$rpm" | sed "s/\.fc[0-9]*\.x86_64\.rpm/+${KVER}.x86_64.rpm/")
              mv "$rpm" "$NEW_NAME"
            fi
          done
        env:
          MACCEL_VERSION: ${{ steps.version.outputs.version }}

      - name: Lint packages
        run: |
          rpmlint ~/rpmbuild/RPMS/x86_64/*.rpm || true
        continue-on-error: true

      - name: Setup GPG for signing
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 -d > private.key
          gpg --batch --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
            --import private.key
          echo -e "5\ny\n" | gpg --batch --command-fd 0 \
            --edit-key "${{ secrets.GPG_KEY_ID }}" trust
          rm private.key

      - name: Sign RPM packages
        run: |
          echo "%_gpg_name ${{ secrets.GPG_KEY_ID }}" > ~/.rpmmacros
          echo "%__gpg /usr/bin/gpg" >> ~/.rpmmacros
          echo "%_gpg_sign_cmd_extra_args --batch --no-tty --yes --pinentry-mode loopback --passphrase '${{ secrets.GPG_PASSPHRASE }}'" >> ~/.rpmmacros
          cd ~/rpmbuild/RPMS/x86_64
          rpm --addsign *.rpm

      - name: Prepare release packages
        run: |
          mkdir -p release-packages
          # Copy akmod packages if built
          if [ "${{ github.event.inputs.build_akmod }}" == "true" ]; then
            cp ~/rpmbuild/RPMS/x86_64/akmod-maccel-*.rpm release-packages/ 2>/dev/null || true
          fi
          # Copy CLI packages if built
          if [ "${{ github.event.inputs.build_cli }}" == "true" ]; then
            cp ~/rpmbuild/RPMS/x86_64/maccel-*.rpm release-packages/ 2>/dev/null || true
          fi
          # Copy kmod packages if built
          if [ "${{ github.event.inputs.build_kmod }}" == "true" ]; then
            cp ~/rpmbuild/RPMS/x86_64/kmod-maccel-*.rpm release-packages/ 2>/dev/null || true
          fi
          # Exclude akmod-akmod-maccel and kmod-akmod-maccel (kmodtool stubs)
          rm -f release-packages/akmod-akmod-maccel-*.rpm
          rm -f release-packages/kmod-akmod-maccel-*.rpm
          # Copy source RPMs if any packages were built
          cp ~/rpmbuild/SRPMS/*.src.rpm release-packages/ 2>/dev/null || true
          
      - name: Create repository metadata
        run: |
          mkdir -p repo
          cp release-packages/*.rpm repo/
          createrepo_c repo/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: |
            release-packages/
            repo/

  publish:
    needs: build-rpm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-packages
          path: artifacts/

      - name: Create release with packages
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.build-rpm.outputs.version }}
          files: artifacts/release-packages/*
          body: |
            RPM packages for maccel ${{ needs.build-rpm.outputs.version }}

            **Build Information:**
            - Container Image: `${{ needs.build-rpm.outputs.container_image }}`
            - Container Digest: `${{ needs.build-rpm.outputs.container_digest }}`
            - Kernel Version: `${{ needs.build-rpm.outputs.kernel_version }}`

            **Installation:**
            ```bash
            sudo wget https://raw.githubusercontent.com/${{ github.repository }}/main/maccel.repo -O /etc/yum.repos.d/maccel.repo && sudo dnf install maccel
            ```

            **Post-install:** `sudo usermod -aG maccel $USER` (log out and back in)

      - name: Prepare merged repository
        run: |
          # Install createrepo_c for metadata generation
          dnf install -y createrepo_c
          
          # Prepare repo directory with new packages
          mkdir -p repo
          cp artifacts/repo/*.rpm repo/ 2>/dev/null || true
          
          # Regenerate repository metadata to include all packages
          createrepo_c repo/

      - name: Deploy repo to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: repo
          keep_files: true
