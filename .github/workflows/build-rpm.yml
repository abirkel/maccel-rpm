---
name: Build and Publish RPM Packages

'on':
  workflow_dispatch:
    inputs:
      kernel_types:
        description: >-
          Kernel types to build (comma-separated: main, bazzite,
          or main,bazzite)
        required: false
        type: string
        default: 'main'
      kernel_version:
        description: 'Specific kernel version (leave empty for latest)'
        required: false
        type: string
        default: ''
      maccel_version:
        description: 'Maccel version to build (e.g., v0.5.6)'
        required: false
        type: string
        default: ''
      build_kmod:
        description: 'Build kmod package'
        required: false
        type: boolean
        default: true
      build_cli:
        description: >-
          Build CLI package (only built for main kernel type)
        required: false
        type: boolean
        default: true
      container_image:
        description: >-
          Container image for build (leave empty to use build.conf default)
        required: false
        type: string
        default: ''
      fedora_version:
        description: >-
          Fedora version (leave empty to use build.conf default)
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      kernel_types:
        description: >-
          Kernel types to build (comma-separated: main, bazzite,
          or main,bazzite)
        required: false
        type: string
        default: 'main'
      kernel_version:
        description: 'Specific kernel version (leave empty for latest)'
        required: false
        type: string
        default: ''
      maccel_version:
        description: 'Maccel version to build (e.g., v0.5.6)'
        required: false
        type: string
        default: ''
      build_kmod:
        description: 'Build kmod package'
        required: false
        type: boolean
        default: true
      build_cli:
        description: >-
          Build CLI package (only built for main kernel type)
        required: false
        type: boolean
        default: true
      container_image:
        description: >-
          Container image for build (leave empty to use build.conf default)
        required: false
        type: string
        default: ''
      fedora_version:
        description: >-
          Fedora version (leave empty to use build.conf default)
        required: false
        type: string
        default: ''

permissions:
  contents: write
  packages: write

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      container_image: ${{ steps.config.outputs.container_image }}
      container_version: ${{ steps.config.outputs.container_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load configuration
        id: config
        run: |
          source build.conf

          # Use workflow inputs if provided, otherwise use config defaults
          INPUT_IMAGE="${{ github.event.inputs.container_image }}"
          INPUT_VERSION="${{ github.event.inputs.fedora_version }}"

          FINAL_IMAGE="${INPUT_IMAGE:-$CONTAINER_IMAGE}"
          FINAL_VERSION="${INPUT_VERSION:-$CONTAINER_VERSION}"

          echo "container_image=$FINAL_IMAGE" >> $GITHUB_OUTPUT
          echo "container_version=$FINAL_VERSION" >> $GITHUB_OUTPUT

  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate build matrix
        id: set-matrix
        run: |
          KERNEL_TYPES="${{ inputs.kernel_types }}"

          # Parse comma-separated kernel types
          IFS=',' read -ra TYPES <<< "$KERNEL_TYPES"

          # Build JSON matrix
          MATRIX_JSON='{"include":['
          FIRST=true

          for TYPE in "${TYPES[@]}"; do
            # Trim whitespace
            TYPE=$(echo "$TYPE" | xargs)

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX_JSON="$MATRIX_JSON,"
            fi

            # Only main kernel type builds CLI
            if [ "$TYPE" = "main" ]; then
              BUILD_CLI="true"
            else
              BUILD_CLI="false"
            fi

            MATRIX_JSON="$MATRIX_JSON"'{"kernel_type":"'"$TYPE"'",'
            MATRIX_JSON="$MATRIX_JSON"'"build_cli":"'"$BUILD_CLI"'"}'
          done

          MATRIX_JSON="$MATRIX_JSON"']}'

          echo "Generated matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  resolve-versions:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    outputs:
      maccel_version: ${{ steps.maccel.outputs.maccel_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: Determine maccel version
        id: maccel
        run: |
          # Use workflow input if provided, otherwise read from file
          INPUT_VERSION="${{ inputs.maccel_version }}"
          if [ -n "$INPUT_VERSION" ]; then
            echo "maccel_version=$INPUT_VERSION" >> $GITHUB_OUTPUT
            echo "Using maccel version from workflow input: $INPUT_VERSION"
          elif [ -f .external_versions ]; then
            source .external_versions
            echo "maccel_version=$MACCEL_VERSION" >> $GITHUB_OUTPUT
            echo "Using maccel version from .external_versions: $MACCEL_VERSION"
          else
            echo "ERROR: No maccel version specified"
            echo "and .external_versions not found"
            echo "Provide maccel_version input or ensure"
            echo ".external_versions exists"
            exit 1
          fi

      - name: Resolve kernel version
        id: resolve
        run: |
          KERNEL_TYPE="${{ matrix.kernel_type }}"
          EXPLICIT_VERSION="${{ inputs.kernel_version }}"

          # Make script executable
          chmod +x scripts/resolve-kernel-version.sh

          # Resolve kernel version
          if [ -n "$EXPLICIT_VERSION" ]; then
            KERNEL_VERSION=$(./scripts/resolve-kernel-version.sh \
              --kernel-type "$KERNEL_TYPE" \
              --version "$EXPLICIT_VERSION")
          else
            KERNEL_VERSION=$(./scripts/resolve-kernel-version.sh \
              --kernel-type "$KERNEL_TYPE")
          fi

          echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "Resolved kernel version for $KERNEL_TYPE: $KERNEL_VERSION"

          # Store in file for build-rpm job to access
          mkdir -p /tmp/versions
          echo "$KERNEL_VERSION" > "/tmp/versions/${KERNEL_TYPE}_kernel_version"

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-${{ matrix.kernel_type }}
          path: /tmp/versions/${{ matrix.kernel_type }}_kernel_version

  build-rpm:
    needs: [load-config, generate-matrix, resolve-versions]
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    container:
      image: >-
        ${{ needs.load-config.outputs.container_image }}:${{
        needs.load-config.outputs.container_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download version info
        uses: actions/download-artifact@v4
        with:
          name: version-${{ matrix.kernel_type }}
          path: /tmp/versions

      - name: Load kernel version
        id: load_version
        run: |
          KERNEL_TYPE="${{ matrix.kernel_type }}"
          KERNEL_VERSION=$(cat "/tmp/versions/${KERNEL_TYPE}_kernel_version")
          echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "Loaded kernel version for $KERNEL_TYPE: $KERNEL_VERSION"

      - name: Load maccel version
        id: load_maccel
        run: |
          # Use workflow input if provided, otherwise read from file
          INPUT_VERSION="${{ inputs.maccel_version }}"
          if [ -n "$INPUT_VERSION" ]; then
            echo "maccel_version=$INPUT_VERSION" >> $GITHUB_OUTPUT
            echo "Using maccel version from workflow input: $INPUT_VERSION"
          elif [ -f .external_versions ]; then
            source .external_versions
            echo "maccel_version=$MACCEL_VERSION" >> $GITHUB_OUTPUT
            echo "Using maccel version from .external_versions: $MACCEL_VERSION"
          else
            echo "ERROR: No maccel version specified"
            exit 1
          fi

      - name: Install build dependencies
        run: |
          # Step 1: Install base RPM build tools
          dnf install -y rpm-build rpmdevtools rpmlint createrepo_c \
            rpm-sign gnupg2 pinentry spectool kmodtool curl jq

          # Step 2: Install BuildRequires from spec files
          dnf builddep -y specs/*.spec

      - name: Setup RPM build tree
        run: rpmdev-setuptree

      - name: Fetch kernel-devel packages
        if: inputs.build_kmod == true
        run: |
          KERNEL_VERSION="${{ steps.load_version.outputs.kernel_version }}"
          KERNEL_TYPE="${{ matrix.kernel_type }}"
          FEDORA_VERSION="${{ needs.load-config.outputs.container_version }}"

          # Make script executable
          chmod +x scripts/fetch-kernel-packages.sh

          # Fetch kernel packages
          ./scripts/fetch-kernel-packages.sh \
            --kernel-version "$KERNEL_VERSION" \
            --kernel-type "$KERNEL_TYPE" \
            --fedora-version "$FEDORA_VERSION" \
            --output-dir ~/kernel-packages

      - name: Install kernel-devel
        if: inputs.build_kmod == true
        run: |
          dnf install -y ~/kernel-packages/kernel-devel*.rpm

      - name: Determine release number
        id: release
        run: |
          MACCEL_VERSION="${{ steps.load_maccel.outputs.maccel_version }}"
          KERNEL_VERSION="${{ steps.load_version.outputs.kernel_version }}"
          KERNEL_TYPE="${{ matrix.kernel_type }}"

          # Make script executable
          chmod +x scripts/determine-release-number.sh

          # Determine release number
          RELEASE_NUMBER=$(./scripts/determine-release-number.sh \
            --maccel-version "$MACCEL_VERSION" \
            --kernel-version "$KERNEL_VERSION" \
            --kernel-type "$KERNEL_TYPE" \
            --repo "${{ github.repository }}")

          echo "release_number=$RELEASE_NUMBER" >> $GITHUB_OUTPUT
          echo "Determined release number: $RELEASE_NUMBER"

      - name: Download maccel source
        run: |
          for spec in specs/*.spec; do
            spectool -g -R "$spec"
          done

      - name: Copy spec files
        run: |
          cp specs/*.spec ~/rpmbuild/SPECS/

      - name: Build kmod-maccel
        if: inputs.build_kmod == true
        run: |
          cd ~/rpmbuild/SPECS

          KERNEL_VERSION="${{ steps.load_version.outputs.kernel_version }}"
          MACCEL_VERSION="${{ steps.load_maccel.outputs.maccel_version }}"
          RELEASE_NUMBER="${{ steps.release.outputs.release_number }}"

          # Strip 'v' prefix from version if present
          VERSION="${MACCEL_VERSION#v}"

          echo "Building kmod for ${{ matrix.kernel_type }}:"
          echo "  Kernel version: $KERNEL_VERSION"
          echo "  Maccel version: $VERSION"
          echo "  Release number: $RELEASE_NUMBER"

          rpmbuild --define "kernel_version ${KERNEL_VERSION}" \
                   --define "version ${VERSION}" \
                   --define "release ${RELEASE_NUMBER}" \
                   -ba maccel-kmod.spec

      - name: Build maccel CLI
        if: inputs.build_cli == true && matrix.build_cli == 'true'
        run: |
          cd ~/rpmbuild/SPECS

          MACCEL_VERSION="${{ steps.load_maccel.outputs.maccel_version }}"
          RELEASE_NUMBER="${{ steps.release.outputs.release_number }}"

          # Strip 'v' prefix from version if present
          VERSION="${MACCEL_VERSION#v}"

          echo "Building CLI for:"
          echo "  Maccel version: $VERSION"
          echo "  Release number: $RELEASE_NUMBER"

          rpmbuild --define "version ${VERSION}" \
                   --define "release ${RELEASE_NUMBER}" \
                   -ba maccel.spec

      - name: Lint packages
        run: |
          rpmlint ~/rpmbuild/RPMS/x86_64/*.rpm || true
        continue-on-error: true

      - name: Prepare release packages
        run: |
          set -euo pipefail
          mkdir -p release-packages

          # Copy kmod packages if built
          if [ "${{ inputs.build_kmod }}" == "true" ]; then
            if ls ~/rpmbuild/RPMS/x86_64/kmod-maccel-*.rpm \
                1>/dev/null 2>&1; then
              cp ~/rpmbuild/RPMS/x86_64/kmod-maccel-*.rpm \
                release-packages/
            else
              echo "ERROR: kmod package build requested but not found"
              exit 1
            fi
          fi

          # Copy CLI packages if built (only for main kernel type)
          if [ "${{ inputs.build_cli }}" == "true" ] && \
             [ "${{ matrix.build_cli }}" == "true" ]; then
            if ls ~/rpmbuild/RPMS/x86_64/maccel-*.rpm 1>/dev/null 2>&1; then
              cp ~/rpmbuild/RPMS/x86_64/maccel-*.rpm release-packages/
            else
              echo "ERROR: CLI package build requested but not found"
              exit 1
            fi
          fi

          # Copy source RPMs if any packages were built
          if ls ~/rpmbuild/SRPMS/*.src.rpm 1>/dev/null 2>&1; then
            cp ~/rpmbuild/SRPMS/*.src.rpm release-packages/
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ matrix.kernel_type }}
          path: release-packages/

  publish:
    needs: [build-rpm, resolve-versions]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: rpm-packages-*
          merge-multiple: true

      - name: List downloaded packages
        run: |
          echo "Downloaded packages:"
          ls -lh artifacts/

      - name: Install RPM signing tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm gnupg2

      - name: Setup GPG for signing
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 -d > private.key
          gpg --batch --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
            --import private.key
          echo -e "5\ny\n" | gpg --batch --command-fd 0 \
            --edit-key "${{ secrets.GPG_KEY_ID }}" trust
          rm private.key

      - name: Sign all RPM packages
        run: |
          echo "%_gpg_name ${{ secrets.GPG_KEY_ID }}" > ~/.rpmmacros
          echo "%__gpg /usr/bin/gpg" >> ~/.rpmmacros
          echo "%_gpg_sign_cmd_extra_args --batch --no-tty --yes \
            --pinentry-mode loopback --passphrase \
            '${{ secrets.GPG_PASSPHRASE }}'" >> ~/.rpmmacros

          # Sign all RPM packages
          cd artifacts
          for rpm in *.rpm; do
            if [ -f "$rpm" ]; then
              echo "Signing $rpm"
              rpm --addsign "$rpm"
            fi
          done

      - name: Verify package signatures
        run: |
          cd artifacts
          for rpm in *.rpm; do
            if [ -f "$rpm" ]; then
              echo "Verifying signature for $rpm"
              rpm --checksig "$rpm"
            fi
          done

      - name: Prepare release notes
        id: release_notes
        run: |
          VER="${{ needs.resolve-versions.outputs.maccel_version }}"
          KERNEL_TYPES="${{ inputs.kernel_types }}"
          REPO="${{ github.repository }}"

          {
            echo "notes<<EOF"
            echo "RPM packages for maccel **$VER**"
            echo ""
            echo "**Kernel Types:** $KERNEL_TYPES"
            echo ""
            echo "> **Note:** The kmod packages are built for"
            echo "> specific kernel versions. Install the package"
            echo "> matching your kernel type (main for Aurora,"
            echo "> bazzite for Bazzite)."
            echo ""
            echo "## Installation"
            echo "\`\`\`bash"
            echo "sudo wget \\"
            echo "  https://raw.githubusercontent.com/$REPO/main/maccel.repo \\"
            echo "  -O /etc/yum.repos.d/maccel.repo && \\"
            echo "  sudo dnf install maccel"
            echo "\`\`\`"
            echo ""
            echo "**Post-install:** \`sudo usermod -aG maccel \$USER\`"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ needs.resolve-versions.outputs.maccel_version }}
          files: artifacts/*.rpm
          body: ${{ steps.release_notes.outputs.notes }}
          fail_on_unmatched_files: false
          # This will update existing release if it exists

      - name: Prepare merged repository
        run: |
          set -euo pipefail

          # Install createrepo_c for metadata generation
          sudo apt-get update
          sudo apt-get install -y createrepo-c

          # Clone existing gh-pages branch to get current packages
          echo "Cloning existing gh-pages branch..."
          git clone --depth=1 --branch=gh-pages \
            https://github.com/${{ github.repository }}.git gh-pages-repo \
            || mkdir -p gh-pages-repo

          # Prepare repo directory with existing + new packages
          mkdir -p repo

          # Copy existing RPM files from gh-pages (if any)
          if [ -d "gh-pages-repo" ]; then
            echo "Copying existing packages from gh-pages..."
            find gh-pages-repo -maxdepth 1 -name "*.rpm" \
              -exec cp {} repo/ \; 2>/dev/null || true
          fi

          # Copy new signed packages
          echo "Copying new signed packages..."
          cp artifacts/*.rpm repo/ 2>/dev/null || true

          # List all packages in repo
          echo "Packages in repository:"
          ls -lh repo/*.rpm 2>/dev/null || echo "No packages found"

          # Regenerate metadata for ALL packages
          echo "Regenerating repository metadata..."
          createrepo_c repo/

          echo "Repository preparation complete"

      - name: Deploy repository to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: repo
          keep_files: false
          # keep_files: false ensures clean deployment
          # All packages are in repo/ so nothing is lost
